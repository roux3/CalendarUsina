<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usina Calendário</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2693/2693507.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Smooth fade transitions */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        .slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        /* Hide scrollbar for clean look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden relative">

    <!-- === VIEW: LOGIN === -->
    <div id="view-login" class="flex-1 flex flex-col items-center justify-center p-6 hidden">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-xl text-center fade-in">
            <div class="mb-6 text-brand-600">
                <i class="fa-solid fa-plane-departure text-5xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-slate-900 mb-2">Bem-vindo(a)!</h1>
            <p class="text-slate-500 mb-6">Digite seu nome para acessar o calendário de feriados e planejar suas
                viagens.</p>

            <form id="login-form" class="space-y-4">
                <input type="text" id="username-input"
                    class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition"
                    placeholder="Seu nome" required autocomplete="off">

                <input type="tel" id="phone-input"
                    class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition"
                    placeholder="WhatsApp (DDD) 99999-9999" required autocomplete="off" maxlength="15">

                <button type="submit"
                    class="w-full bg-brand-600 hover:bg-brand-700 text-white font-semibold py-3 rounded-lg transition shadow-md shadow-brand-500/30">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- === VIEW: CALENDAR === -->
    <div id="view-calendar" class="flex-1 flex flex-col hidden h-full">
        <!-- Header -->
        <header
            class="bg-white border-b border-slate-200 px-6 py-4 shadow-sm z-10 flex justify-between items-center sticky top-0">
            <div>
                <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Olá, <span id="user-greeting"
                        class="text-brand-600 font-bold"></span></p>
                <h2 class="text-xl font-bold text-slate-800">Calendário 2026</h2>
            </div>
            <div class="flex items-center gap-3">
                <button id="btn-install"
                    class="hidden text-xs bg-brand-600 text-white px-3 py-1.5 rounded-full font-bold shadow-sm active:scale-95 transition">
                    <i class="fa-solid fa-download mr-1"></i> Instalar App
                </button>
                <div class="h-10 w-10 bg-brand-50 rounded-full flex items-center justify-center text-brand-600">
                    <i class="fa-regular fa-calendar"></i>
                </div>
            </div>
        </header>

        <!-- Full Calendar Grid -->
        <main class="flex-1 overflow-y-auto p-4 no-scrollbar scroll-smooth" id="calendar-container">
            <!-- Months will be injected here -->
        </main>
    </div>

    <!-- === COMPONENT: MODAL (Backdrop + Content) === -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 hidden transition-opacity opacity-0"
        aria-hidden="true"></div>

    <div id="modal-panel"
        class="fixed bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-[480px] md:-translate-x-1/2 md:-translate-y-1/2
        bg-white rounded-t-3xl md:rounded-2xl p-6 shadow-2xl z-50 transform translate-y-full transition-transform duration-300 ease-out hidden">

        <!-- Drag Handle / Close Button for Mobile -->
        <div class="mx-auto w-12 h-1.5 bg-slate-200 rounded-full mb-6 md:hidden"></div>

        <!-- Dynamic Content Container -->
        <div id="modal-content-wrapper">
            <!-- Content Injected via JS -->
        </div>
    </div>

    <!-- === TOAST NOTIFICATION === -->
    <div id="toast"
        class="fixed top-4 right-4 bg-white border-l-4 border-green-500 shadow-lg rounded-lg p-4 transform translate-x-[150%] transition-transform duration-300 z-50 max-w-xs flex items-center gap-3">
        <div class="text-green-500 text-xl"><i class="fa-solid fa-circle-check"></i></div>
        <div>
            <h4 class="font-bold text-slate-800 text-sm">Sucesso!</h4>
            <p id="toast-message" class="text-slate-500 text-xs text-start">Operação realizada com sucesso.</p>
        </div>
    </div>

    <!-- === JAVASCRIPT LOGIC === -->
    <script type="module">
        // Import Firebase (Modular Web SDK)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // CONFIGURAÇÃO DO FIREBASE (INSIRA AQUI)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDTHu6_f_v4XeUe6qW31IJXWIgcjn0JLnI",
            authDomain: "calendarusina.firebaseapp.com",
            projectId: "calendarusina",
            storageBucket: "calendarusina.firebasestorage.app",
            messagingSenderId: "1037753349354",
            appId: "1:1037753349354:web:0bd375b56c875597555393",
            measurementId: "G-XNCQL9FPY4"
        };

        // Initialize Firebase
        let db;
        try {
            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
            } else {
                console.warn("Firebase não configurado. As ações serão simuladas no console.");
            }
        } catch (e) {
            console.error("Erro ao inicializar Firebase:", e);
        }

        // ==========================================
        // DADOS & ESTADO
        // ==========================================
        const feriados = [
            { "data": "01/01/2026", "evento": "Confraternização Universal", "tipo": "Nacional" },
            { "data": "02/01/2026", "evento": "Ponte (Confraternização Universal)", "tipo": "Compensado" },
            { "data": "16/02/2026", "evento": "Véspera de Carnaval (Integral)", "tipo": "Compensado" },
            { "data": "17/02/2026", "evento": "Carnaval (Integral)", "tipo": "Compensado" },
            { "data": "18/02/2026", "evento": "Cinzas (Integral)", "tipo": "Compensado" },
            { "data": "03/04/2026", "evento": "Paixão de Cristo", "tipo": "Nacional" },
            { "data": "20/04/2026", "evento": "Ponte Tiradentes", "tipo": "Compensado" },
            { "data": "21/04/2026", "evento": "Tiradentes / Dia do Estado de MG", "tipo": "Nacional" },
            { "data": "29/04/2026", "evento": "Emancipação Municipal da Cidade", "tipo": "Municipal" },
            { "data": "01/05/2026", "evento": "Dia do Trabalhador", "tipo": "Nacional" },
            { "data": "04/06/2026", "evento": "Corpus Christi", "tipo": "Municipal" },
            { "data": "05/06/2026", "evento": "Ponte Corpus Christi (Integral)", "tipo": "Compensado" },
            { "data": "07/09/2026", "evento": "Independência do Brasil", "tipo": "Nacional" },
            { "data": "12/10/2026", "evento": "Nossa Senhora Aparecida (Padroeira do Brasil)", "tipo": "Nacional" },
            { "data": "02/11/2026", "evento": "Finados", "tipo": "Nacional" },
            { "data": "15/11/2026", "evento": "Proclamação da República", "tipo": "Nacional" },
            { "data": "20/11/2026", "evento": "Dia da Consciência Negra", "tipo": "Nacional" },
            { "data": "24/12/2026", "evento": "Véspera de Natal (Integral)", "tipo": "Compensado" },
            { "data": "25/12/2026", "evento": "Natal", "tipo": "Nacional" },
            { "data": "31/12/2026", "evento": "Véspera de Ano Novo (Integral)", "tipo": "Compensado" }
        ];

        const feriadosMap = {};
        feriados.forEach(f => feriadosMap[f.data] = f);

        let currentUser = localStorage.getItem("sankyu_user_name");
        let currentPhone = localStorage.getItem("sankyu_user_phone");
        let selectedDateDetails = null;
        let reservationsMap = {}; // Key: "DD/MM/YYYY", Value: { id, nomeUsuario, observacao, collection }

        // ==========================================
        // PWA LOGIC
        // ==========================================
        let deferredPrompt;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker Registrado!', reg))
                    .catch(err => console.log('SW Falhou:', err));
            });
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;
            // Update UI to notify the user they can add to home screen
            const installBtn = document.getElementById('btn-install');
            installBtn.classList.remove('hidden');

            installBtn.addEventListener('click', () => {
                // Hide our user interface that shows our A2HS button
                installBtn.classList.add('hidden');
                // Show the prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the A2HS prompt');
                    } else {
                        console.log('User dismissed the A2HS prompt');
                    }
                    deferredPrompt = null;
                });
            });
        });

        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            showToast("Aplicativo instalado com sucesso!");
        });

        // ==========================================
        // INICIALIZAÇÃO
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            if (currentUser) {
                initAuthenticatedApp();
            } else {
                showLogin();
            }
        });

        function initAuthenticatedApp() {
            showCalendar();
            setupRealtimeListeners();
            // Try to auto-scroll after a short delay to ensure render
            setTimeout(scrollToCurrentMonth, 500);
        }

        // ==========================================
        // AUTH
        // ==========================================
        function showLogin() {
            document.getElementById('view-login').classList.remove('hidden');

            // Mask Logic
            const phoneInput = document.getElementById('phone-input');
            phoneInput.addEventListener('input', (e) => {
                let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
            });

            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('username-input').value.trim();
                const phone = phoneInput.value.trim();

                if (name && phone.length >= 14) {
                    currentUser = name;
                    currentPhone = phone;
                    localStorage.setItem("sankyu_user_name", name);
                    localStorage.setItem("sankyu_user_phone", phone);
                    document.getElementById('view-login').classList.add('hidden');
                    initAuthenticatedApp();
                } else {
                    alert("Por favor, preencha o nome e um telefone válido.");
                }
            });
        }

        // ==========================================
        // FIREBASE LISTENERS
        // ==========================================
        function setupRealtimeListeners() {
            if (!db) return;

            // Listen to trips
            onSnapshot(collection(db, "viagens_planejadas"), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const date = data.dataFeriado;
                    if (change.type === "added" || change.type === "modified") {
                        reservationsMap[date] = { ...data, id: change.doc.id, collection: "viagens_planejadas" };
                    } else if (change.type === "removed") {
                        delete reservationsMap[date];
                    }
                });
                renderFullYear(2026); // Re-render to show updates
            });

            // Listen to days off
            onSnapshot(collection(db, "folgas_programadas"), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const date = data.dataFolga;
                    if (change.type === "added" || change.type === "modified") {
                        reservationsMap[date] = { ...data, id: change.doc.id, collection: "folgas_programadas" };
                    } else if (change.type === "removed") {
                        delete reservationsMap[date];
                    }
                });
                renderFullYear(2026);
            });
        }

        // ==========================================
        // VISUALIZAÇÃO DO CALENDÁRIO
        // ==========================================
        function showCalendar() {
            document.getElementById('view-calendar').classList.remove('hidden');
            document.getElementById('user-greeting').textContent = currentUser;
        }

        function scrollToCurrentMonth() {
            const today = new Date();
            // Note: Our calendar is hardcoded for 2026. 
            // If we are in 2026, scroll to month. Else, scroll to Jan or stick to top.
            // Assuming testing is in context of using it, let's pretend 2026 or just map current month index.

            // For demo purposes, we will mock current date as "Real Today" but year 2026 if year matches, 
            // otherwise just scroll to current month index regardless of year (UX preference).
            const currentMonthIndex = today.getMonth();
            const monthElement = document.getElementById(`month-section-${currentMonthIndex}`);
            if (monthElement) {
                monthElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function renderFullYear(year) {
            const container = document.getElementById('calendar-container');
            container.innerHTML = "";

            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const weekdays = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];

            const today = new Date();
            // Check if "today" is in 2026 for highlight purposes
            const is2026 = today.getFullYear() === 2026 || true; // Force true for demo if needed, but let's be strict if valid date
            const todayStr = is2026 ? formatDate(year, today.getMonth(), today.getDate()) : "";

            for (let month = 0; month < 12; month++) {
                const section = document.createElement('div');
                section.id = `month-section-${month}`;
                section.className = "mb-8 bg-white rounded-lg p-4 shadow-sm border border-slate-100";

                section.innerHTML = `
                    <h3 class="text-lg font-bold text-slate-800 mb-4 capitalize border-b border-slate-100 pb-2">${monthNames[month]}</h3>
                    <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                        ${weekdays.map(d => `<span class="text-xs font-bold text-slate-400 uppercase">${d}</span>`).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center" id="month-grid-${month}"></div>
                `;
                container.appendChild(section);

                renderMonthGrid(year, month, `month-grid-${month}`, todayStr);
            }
        }

        function renderMonthGrid(year, month, elementId, todayStr) {
            const grid = document.getElementById(elementId);
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(year, month, day);
                const dateObj = new Date(year, month, day);
                const dayOfWeek = dateObj.getDay();
                const holiday = feriadosMap[dateStr];
                const reservation = reservationsMap[dateStr];

                const cell = document.createElement('div');
                cell.className = "aspect-square flex flex-col items-center justify-center rounded-lg text-sm transition cursor-pointer relative select-none hover:ring-2 hover:ring-offset-1 hover:ring-brand-200";

                // --- STYLES ---
                // 1. Background/Type
                if (reservation && reservation.collection === 'folgas_programadas') {
                    cell.classList.add("bg-blue-100", "text-green-700", "font-bold");
                } else if (holiday) {
                    if (holiday.tipo === "Compensado") cell.classList.add("bg-orange-100", "text-orange-700", "font-bold");
                    else cell.classList.add("bg-red-100", "text-red-700", "font-bold");
                } else if (dayOfWeek === 0 || dayOfWeek === 6) {
                    cell.classList.add("bg-slate-50", "text-slate-400");
                } else {
                    cell.classList.add("bg-white", "text-slate-700", "border", "border-slate-100");
                }

                // 2. Reservation Highlight (Border)
                if (reservation) {
                    cell.classList.add("border-2", "border-indigo-600");
                }

                // 3. Today Highlight
                // Using a date that matches today's day/month (ignoring year for recurring calendar feel or strictly using passed in todayStr)
                // Assuming we want to show 'today' if we are looking at 2026. If current real year is 2026.
                // For logic simplicity, checking day/month matches real today.
                const realToday = new Date();
                if (realToday.getDate() === day && realToday.getMonth() === month && realToday.getFullYear() === year) {
                    cell.classList.add("ring-2", "ring-emerald-400", "bg-emerald-50");
                }

                // Content
                cell.innerHTML = `<span>${day}</span>`;

                // Mini indicator for reservation owner? (Too small, user requested "Responsável: [Nome]" inside... maybe just inside modal?
                // "Dentro do dia marcado no calendário, ou na modal de detalhes..." -> "Inside the marked day... OR in the modal". 
                // Given the cell size, text won't fit well. I'll put it in modal mostly, maybe a tiny dot or initial here if needed, 
                // but highlight border covers the "marked" status.

                cell.onclick = () => handleDateClick(dateObj, holiday, reservation);
                grid.appendChild(cell);
            }
        }

        function formatDate(year, month, day) {
            const d = String(day).padStart(2, '0');
            const m = String(month + 1).padStart(2, '0');
            return `${d}/${m}/${year}`;
        }

        // ==========================================
        // INTERAÇÃO E MODAIS
        // ==========================================
        function handleDateClick(dateObj, holiday, reservation) {
            const dayOfWeek = dateObj.getDay();

            if (reservation) {
                // VIEW MODE (Already Reserved)
                openViewModal(reservation, dateObj, holiday);
            } else {
                // ADD MODE
                if (holiday) {
                    openHolidayModal(holiday, dateObj);
                } else if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    openDayOffModal(dateObj);
                }
            }
        }

        // --- ADD MODALS ---

        function openHolidayModal(holiday, dateObj) {
            selectedDateDetails = { type: 'holiday', data: holiday, dateObj: dateObj };
            const weather = getMockWeather(dateObj);
            const tip = getTravelTip(holiday, dateObj);

            updateModalContent(`
                <div class="flex items-start justify-between mb-2">
                    <div>
                        <span class="inline-block px-2 py-1 text-xs font-semibold rounded bg-slate-100 text-slate-600 mb-2">${holiday.tipo}</span>
                        <h3 class="text-2xl font-bold text-slate-900 leading-tight">${holiday.evento}</h3>
                    </div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 p-2"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                
                <p class="text-slate-500 font-medium text-lg mb-4 flex items-center gap-2">
                    <i class="fa-regular fa-clock"></i> <span>${holiday.data}</span>
                </p>

                <div class="bg-blue-50 rounded-xl p-4 mb-4 flex items-center gap-4">
                    <div class="text-3xl text-blue-500 w-12 text-center">${weather.icon}</div>
                    <div class="flex-1">
                        <p class="text-blue-700 text-xs font-bold uppercase">Clima</p>
                        <p class="text-blue-900 text-sm font-medium">${weather.desc}</p>
                    </div>
                </div>

                <div class="rounded-xl p-4 mb-4 border flex items-start gap-3 ${tip.style}">
                    <i class="fa-solid fa-lightbulb mt-1"></i>
                    <p class="text-sm italic">${tip.text}</p>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Observação</label>
                    <textarea id="obs-input" rows="2" class="w-full border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none border" placeholder="Ex: Viagem para praia..."></textarea>
                </div>

                <button id="btn-action" onclick="saveAction()" class="w-full py-4 rounded-xl font-bold text-white shadow-lg transition-all active:scale-95 bg-blue-600 hover:bg-blue-700">
                    Marcar desejo de viajar
                </button>
            `);
            openModalUI();
        }

        function openDayOffModal(dateObj) {
            selectedDateDetails = { type: 'dayOff', dateObj: dateObj };
            const dateStr = dateObj.toLocaleDateString('pt-BR');
            const weekday = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });

            updateModalContent(`
                <div class="flex items-start justify-between mb-2">
                    <div>
                         <span class="inline-block px-2 py-1 text-xs font-semibold rounded bg-green-100 text-green-700 mb-2">Banco de Horas</span>
                        <h3 class="text-2xl font-bold text-slate-900 leading-tight">Programar Folga</h3>
                    </div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 p-2"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                
                <p class="text-slate-500 text-base mb-6">
                    Dia <strong class="text-slate-800">${dateStr}</strong> (<span class="capitalize">${weekday}</span>).
                </p>

                <div class="mb-6">
                     <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Observação</label>
                    <textarea id="obs-input" rows="2" class="w-full border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-green-500 outline-none border" placeholder="Ex: Assuntos pessoais..."></textarea>
                </div>

                <button id="btn-action" onclick="saveAction()" class="w-full py-4 rounded-xl font-bold text-white shadow-lg transition-all active:scale-95 bg-green-600 hover:bg-green-700">
                    Confirmar Folga
                </button>
            `);
            openModalUI();
        }

        // --- VIEW / DELETE MODAL ---

        function openViewModal(reservation, dateObj, holiday) {
            const dateStr = dateObj.toLocaleDateString('pt-BR');
            selectedDateDetails = { reservationId: reservation.id, collectionName: reservation.collection };

            const isTravel = reservation.collection === "viagens_planejadas";
            const title = isTravel ? (holiday ? holiday.evento : "Viagem") : "Folga Programada";
            const badge = isTravel ?
                `<span class="bg-blue-100 text-blue-700 px-2 py-1 text-xs font-bold rounded">Viagem</span>` :
                `<span class="bg-green-100 text-green-700 px-2 py-1 text-xs font-bold rounded">Folga</span>`;

            updateModalContent(`
                <div class="flex items-start justify-between mb-4">
                    <div>
                        ${badge}
                        <h3 class="text-2xl font-bold text-slate-900 leading-tight mt-2">${title}</h3>
                    </div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 p-2"><i class="fa-solid fa-times text-xl"></i></button>
                </div>

                <div class="space-y-4 mb-8">
                    <div class="flex items-center gap-3 text-slate-600">
                         <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><i class="fa-regular fa-calendar"></i></div>
                         <span class="font-medium">${dateStr}</span>
                    </div>
                    <div class="flex items-center gap-3 text-slate-600">
                         <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-user"></i></div>
                         <div>
                            <span class="text-xs uppercase text-slate-400 font-bold block">Responsável</span>
                            <span class="font-medium text-slate-800">${reservation.nomeUsuario}</span>
                         </div>
                    </div>
                    <div class="flex items-start gap-3 text-slate-600">
                         <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center shrink-0"><i class="fa-solid fa-align-left"></i></div>
                         <div>
                            <span class="text-xs uppercase text-slate-400 font-bold block">Observação</span>
                            <p class="font-medium text-slate-800">${reservation.observacao || "<em>Sem observação</em>"}</p>
                         </div>
                    </div>
                </div>

                <button id="btn-delete" onclick="deleteAction()" class="w-full py-4 rounded-xl font-bold text-white shadow-lg transition-all active:scale-95 bg-red-500 hover:bg-red-600 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-trash"></i> Desmarcar
                </button>
            `);
            openModalUI();
        }

        function updateModalContent(html) {
            document.getElementById('modal-content-wrapper').innerHTML = html;
        }

        // --- HELPERS ---
        function getMockWeather(dateObj) {
            const month = dateObj.getMonth();
            if (month >= 11 || month <= 2) return { icon: '<i class="fa-solid fa-sun text-yellow-500"></i>', desc: "Ensolarado, ~30°C." };
            if (month >= 3 && month <= 5) return { icon: '<i class="fa-solid fa-cloud-sun text-orange-400"></i>', desc: "Ameno, ~24°C." };
            if (month >= 6 && month <= 8) return { icon: '<i class="fa-solid fa-wind text-blue-400"></i>', desc: "Frio/Seco, ~18°C." };
            return { icon: '<i class="fa-solid fa-cloud-sun-rain text-purple-500"></i>', desc: "Primavera, ~26°C." };
        }

        function getTravelTip(holiday, date) {
            const dayOfWeek = date.getDay();
            const isPonte = holiday.evento.toLowerCase().includes("ponte");
            if (dayOfWeek === 1 || dayOfWeek === 5 || isPonte) return { text: "Ótima data! Feriado prolongado.", style: "bg-green-50 border-green-100 text-green-700" };
            if (dayOfWeek > 1 && dayOfWeek < 5) return { text: "Atenção: Meio da semana.", style: "bg-amber-50 border-amber-100 text-amber-700" };
            return { text: "Fim de semana.", style: "bg-blue-50 border-blue-100 text-blue-700" };
        }

        // --- ANIMATIONS ---
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalPanel = document.getElementById('modal-panel');

        function openModalUI() {
            modalBackdrop.classList.remove('hidden');
            modalPanel.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.remove('opacity-0');
                modalPanel.classList.remove('translate-y-full');
            }, 10);
        }

        window.closeModal = function () {
            modalBackdrop.classList.add('opacity-0');
            modalPanel.classList.add('translate-y-full');
            setTimeout(() => {
                modalBackdrop.classList.add('hidden');
                modalPanel.classList.add('hidden');
            }, 300);
        }
        modalBackdrop.addEventListener('click', closeModal);

        // --- STORE ACTIONS ---

        window.saveAction = async function () {
            const btn = document.getElementById('btn-action');
            const obs = document.getElementById('obs-input').value;

            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processando...';
            btn.disabled = true;

            const collectionName = selectedDateDetails.type === 'holiday' ? 'viagens_planejadas' : 'folgas_programadas';
            const payload = {
                nomeUsuario: currentUser,
                telefone: currentPhone,
                notificado: false,
                observacao: obs,
                timestamp: serverTimestamp()
            };

            if (selectedDateDetails.type === 'holiday') {
                payload.dataFeriado = selectedDateDetails.data.data;
                payload.evento = selectedDateDetails.data.evento;
            } else {
                payload.dataFolga = selectedDateDetails.dateObj.toLocaleDateString('pt-BR');
            }

            try {
                if (db) {
                    await addDoc(collection(db, collectionName), payload);
                } else {
                    // Simulate ADD (Since onSnapshot won't fire)
                    // In a real app we rely on onSnapshot. Here we might need to manually update if DB is mock.
                    // Assuming DB is set up by user now.
                    await new Promise(r => setTimeout(r, 600));
                }
                showToast("Agendamento salvo!");
                closeModal();
            } catch (err) {
                console.error(err);
                btn.innerHTML = "Erro ao salvar";
                btn.disabled = false;
            }
        };

        window.deleteAction = async function () {
            const btn = document.getElementById('btn-delete');
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Removendo...';
            btn.disabled = true;

            try {
                if (db) {
                    await deleteDoc(doc(db, selectedDateDetails.collectionName, selectedDateDetails.reservationId));
                } else {
                    await new Promise(r => setTimeout(r, 600));
                }
                showToast("Destaque removido!");
                closeModal();
            } catch (err) {
                console.error(err);
                btn.innerHTML = "Erro ao remover";
                btn.disabled = false;
            }
        };

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg || "Sucesso!";
            toast.classList.remove('translate-x-[150%]');
            setTimeout(() => {
                toast.classList.add('translate-x-[150%]');
            }, 5000);
        }
    </script>
</body>

</html>
